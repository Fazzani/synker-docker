version: "3.5"

services:
  # Let's Encrypt Companion
  letsencrypt-companion:
    image: hamburml/docker-flow-letsencrypt:latest
    environment:
      - DOMAIN_1=('media.synker.ovh')
      - CERTBOT_EMAIL=tunisineheni@gmail.com
      - PROXY_ADDRESS=proxy
      - CERTBOT_CRON_RENEW=('0 3 * * *' '0 15 * * *')
    volumes:
      - nginx_certs:/etc/letsencrypt
    networks:
      - ntw_front
    deploy:
      labels:
        - com.df.servicePath=/.well-known/acme-challenge
        - com.df.notify=true
        - com.df.distribute=true
        - com.df.port=80
      placement:
        constraints: [node.id == <nodeId>]
      replicas: 1

  nginx-proxy:
    image: nginx:latest
    ports:
      - "88:80"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./nginx-proxy/default.conf:/etc/nginx/nginx.conf:ro
      - nginx_html:/usr/share/nginx/html
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5m
        max_attempts: 3
        window: 120s
      labels:
        - "traefik.backend=nginx-proxy"
        - "traefik.backend.loadbalancer.swarm=true"
        - "traefik.backend.loadbalancer.method=drr"
        - "traefik.frontend.entryPoints=http,https"
        - "traefik.frontend.rule=Host:media.synker.ovh"
        - "traefik.docker.network=ntw_front"
        - "traefik.port=88"
        - "traefik.enable=true"

volumes:
  nginx_certs:
    driver_opts:
      type: "nfs"
      o: "nolock,soft,rw,addr=151.80.235.155"
      device: ":/mnt/nfs/media/certs"
  nginx_html:
    driver_opts:
      type: "nfs"
      o: "nolock,soft,rw,addr=151.80.235.155"
      device: ":/mnt/nfs/media/html"
 
networks:
  ntw_front:
    external: true