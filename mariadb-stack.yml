version: '3.5'

services:

  synker_db:
    image: mariadb:${MYSQL_VERSION}
    restart: always
    volumes:
      - ./mysql:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD: /run/secrets/MYSQL_ROOT_PASSWORD
      - MYSQL_USER: ${MYSQL_USER}
      - MYSQL_PASSWORD: /run/secrets/MYSQL_PASSWORD
      - MYSQL_DATABASE: ${MYSQL_DATABASE}
      - MYSQL_ROOT_HOST: "%"
    ports:
      - "8889:3306"
    networks:
      - elk_elk
    volumes:
      - mariadb_data:/var/lib/mysql
    deploy:
     mode: replicated
     replicas: 1
     restart_policy:
       condition: on-failure
       delay: 20m
       max_attempts: 3
       window: 120s
     placement:
       constraints: 
         - node.labels.size == large
    secrets:
      - MYSQL_PASSWORD
      - MYSQL_ROOT_PASSWORD
volumes:
  mariadb_data:
    driver_opts:
      type: "nfs"
      o: "nolock,soft,rw,addr=18.194.42.216"
      device: ":/webgrab_volume/mariadb/data"
secrets:
  MYSQL_PASSWORD:
    external: true
  MYSQL_ROOT_PASSWORD:
    external: true
networks:
  elk_elk:
    external: true